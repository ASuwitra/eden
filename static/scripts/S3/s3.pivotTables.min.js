/*
: 2013 (c) Sahana Software Foundation
 @license: MIT

 requires: jQuery 1.9.1+
 requires: jQuery UI 1.10 widget factory

*/
(function(a,p){var n=0;a.widget("s3.pivottable",{options:{showTotals:!0,hideReportOptions:!0,ajaxURL:null},_create:function(){this.id=n;n+=1;this.table=null},_init:function(){this.refresh();var e=this.element;this.options.hideReportOptions&&(e=a(e).attr("id"),a("#"+e+"-options legend").siblings().toggle(),a("#"+e+"-options legend").children().toggle())},_destroy:function(){this.table.remove()},refresh:function(){var e=this.element,d;this._unbindEvents();var b=a(e).find('input[type="hidden"][name="pivotdata"]');
b.length&&(d=JSON.parse(a(b).first().val()));if(d){var c=d.cells,g=d.cols,h=d.rows,k=d.total,f=d.labels,b=this._renderHeader(g,f);b.append(this._renderColumns(g,f));c=this._renderRows(h,f,c);g=this._renderFooter(h,g,f,k);b=a('<table class="dataTable display report"/>').append(b).append(c);null!==g&&b.append(g);this.table=a(b);a(e).find(".pt-table").first().empty().append(this.table);a(e).find(".pt-empty").hide()}else d={};this._bindEvents(d);a(e).find(".pt-throbber").hide()},_renderHeader:function(e,
d){var b=this.options.showTotals?e.length+1:b=e.length,c=a("<tr>");c.append(a('<th scope="col">'+d.layer+"</th>")).append(a('<th scope="col" colspan="'+b+'">'+d.cols+"</th>"));return a("<thead>").append(c)},_renderColumns:function(e,d){var b=a("<tr>");b.append(a('<th scope="col">'+d.rows+"</th>"));for(var c=0;c<e.length;c++)b.append(a('<th scope="col">'+e[c][2]+"</th>"));this.options.showTotals&&b.append(a('<th class="totals_header row_totals" scope="col">'+d.total+"</th>"));return b},_renderRows:function(e,
d,b){for(var c=a("<tbody>"),g=this.options.showTotals,h,k,f=0;f<b.length;f++)h=e[f],k=a('<tr class="'+(f%2?"odd":"even")+'"><td>'+h[2]+"</td></tr>").append(this._renderCells(b[f],d)),g&&k.append(a("<td>"+h[3]+"</td>")),c.append(k);return c},_renderCells:function(e,d){for(var b,c,g=d.none,h=[],k,f,l=0;l<e.length;l++){b=e[l];c=b.items;k=a("<td>");if(null===c)f=a('<div class="report-cell-value">'+g+"</div>");else if(a.isArray(c)){f=a('<div class="report-cell-value">');list=a("<ul>");for(var m=0;m<c.length;m++)list.append(a("<li>"+
c[m]+"</li>"));f.append(list)}else f=a('<div class="report-cell-value">'+c+"</div>");k.append(f);b=b.keys;c&&(b&&b.length)&&k.data("records",b).append(a('<div class="report-cell-zoom"></div>'));h.push(k)}return h},_renderFooter:function(e,d,b,c){if(this.options.showTotals){e=a('<tr class="'+(e.length%2?"odd":"even")+' totals_row"><th class="totals_header" scope="row">'+b.total+"</th></tr>");for(b=0;b<d.length;b++)e.append(a("<td>"+d[b][3]+"</td>"));e.append(a("<td>"+c+"</td>"));return a("<tfoot>").append(e)}return null},
_getOptions:function(){var e="#"+a(this.element).attr("id");return{rows:a(e+"-rows").val(),cols:a(e+"-cols").val(),fact:a(e+"-fact").val(),totals:a(e+"-totals").is(":checked")?1:0}},_updateAjaxURL:function(a){var d=!1,b=this.options.ajaxURL.split("?"),c={};if(1<b.length){var g=b[1].split("&"),h,k,f,l;f=0;for(l=g.length;f<l;f++)h=g[f].split("="),1<h.length&&"aggregate"!=h[0]&&(c[decodeURIComponent(h[0])]=decodeURIComponent(h[1]))}for(option in a)"totals"==option&&(this.options.showTotals=a[option]?
!0:!1),"rows"!=option&&"cols"!=option&&"fact"!=option||c[option]==a[option]||(d=!0),c[option]=a[option];a=[];for(k in c)a.push(k+"="+c[k]);c=a.join("&");b=b[0];c&&(b=b+"?"+c);this.options.ajaxURL=b;return d},reload:function(e,d){d="undefined"!==typeof d?d:!0;var b=this,c=this.element,g,h=a(c).find('input[type="hidden"][name="pivotdata"]');h.length&&(e&&(g=this._updateAjaxURL(e)),g||d?(g=this.options.ajaxURL,a(c).find(".pt-throbber").show(),a.ajax({url:g,success:function(a){h.first().val(JSON.stringify(a));
b.refresh()},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)},dataType:"json"})):(a(c).find(".pt-throbber").show(),b.refresh()))},_bindEvents:function(e){var d=this,b=this.element,c=a(b).attr("id");a("#"+c+"-options legend").click(function(){a(this).siblings().toggle();a(this).children().toggle()});a("#"+c+"-totals").click(function(){var b=a(this).is(":checked");d.options.showTotals!=b&&d.reload({totals:b},!1)});a(b).find("input.pt-submit").click(function(){var a=
d._getOptions();d.reload(a,!1)});a("#"+c+" div.pt-table div.report-cell-zoom").click(function(b){b=a(b.currentTarget);var c=b.closest("td"),d=c.find(".report-cell-records");if(0<d.length)d.remove(),b.removeClass("opened");else{for(var f=c.data("records"),d=a("<div/>").addClass("report-cell-records"),l=a("<ul/>"),m=0;m<f.length;m++)l.append("<li>"+e.lookup[f[m]]+"</li>");d.append(l);c.append(d);b.addClass("opened")}})},_unbindEvents:function(){var e=this.element,d=a(e).attr("id");a(e).find("input.pt-submit").unbind("click");
a("#"+d+" div.pt-table div.report-cell-zoom").unbind("click");a("#"+d+"-options legend").unbind("click");a(d+"-totals").unbind("click")}})})(jQuery);
