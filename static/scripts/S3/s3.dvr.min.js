/*
 2016 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(c,l){var m=0;c.widget("dvr.eventRegistration",{options:{tablename:"case_event",ajax:null,ajaxURL:""},_create:function(){this.id=m;m+=1;this.namespace=".eventRegistration"},_init:function(){this.idPrefix="#"+this.options.tablename;var a=c(this.element);this.flagInfo=a.find("input[type=hidden][name=flags]");this.permissionInfo=a.find("input[type=hidden][name=permitted]");this.actionableInfo=a.find("input[type=hidden][name=actionable]");this.eventType=a.find('input[type="hidden"][name="event"]');
this.actionDetails=a.find('input[type="hidden"][name="actions"]');this.blockedEvents=(a=a.find('input[type="hidden"][name="intervals"]').val())?JSON.parse(a):{};this.blockingMessage=null;this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options,e=this.idPrefix;this._unbindEvents();a.ajaxURL&&null===a.ajax&&(a.ajax=!0);this._showFlagInfo();c(this.element).find(e+"_details__row .controls").addClass("has-details");this.actionDetails.length?JSON.parse(this.actionDetails.val()).length?
this._showDetails(!0):this._hideDetails():this._hideDetails();this._checkBlockedEvents()||this._toggleSubmit(!1);a=c(e+"_label");a.focus().val(a.val());this._bindEvents()},_checkID:function(){this._clearAlert();var a=c(this.element),e=this.idPrefix,d=c(e+"_label"),b=d.val().trim();d.val(b);if(b){var d={l:b,c:!0},b=this.options.ajaxURL,f=c(e+"_person__row .controls").empty(),g=c('<div class="inline-throbber">').insertAfter(f),h=this;this._clearDetails();c.ajaxS3({url:b,type:"POST",dataType:"json",
contentType:"application/json; charset=utf-8",data:JSON.stringify(d),success:function(b){g.remove();if(b.e)c('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+b.e+"</div></div>").hide().insertAfter(c(e+"_label")).slideDown();else{f.html(b.p).removeClass("hide").show();var d=h.flagInfo;b.f?d.val(JSON.stringify(b.f)):d.val("[]");d=h.permissionInfo;b.s!==l?d.val(JSON.stringify(b.s)):d.val("false");var d=h.actionableInfo,k=b.u;d.length&&(k!==l?d.val(JSON.stringify(b.u)):
(k=!0,d.val("true")));b.d&&h._updateDetails(b.d,k);h.blockedEvents=b.i||{};a.find('input[type="hidden"][name="intervals"]').val(JSON.stringify(h.blockedEvents));h.eventType.val()&&h._toggleSubmit(!0);h._showFlagInfo()}b.a?S3.showAlert(b.a,"error"):b.m&&S3.showAlert(b.m,"success")},error:function(){g.remove();h._clearForm(!0)}})}},_registerEvent:function(){this._clearAlert();var a=this.idPrefix,e=c(a+"_label").val(),d=this.eventType.val();if(e&&d){var e={l:e,t:d},d=this.options.ajaxURL,b=c(a+"_person__row .controls"),
f=c('<div class="inline-throbber">').insertAfter(b),g=this,b=this.actionDetails;b.length&&(b=b.val(),e.d=b?JSON.parse(b):[]);e.c=c(a+"comments").val();c.ajaxS3({url:d,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(e),success:function(b){f.remove();b.e?c('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+b.e+"</div></div>").hide().insertAfter(c(a+"_label")).slideDown():g._clearForm();b.a?S3.showAlert(b.a,"error",
!1):b.m&&S3.showAlert(b.m,"success",!1)},error:function(){f.remove();this._clearForm(!0)}})}},_checkBlockedEvents:function(){var a=this.eventType.val(),a=this.blockedEvents[a];this.blockingMessage&&this.blockingMessage.remove();if(a){var e='<div class="small-12 columns">'+a[0]+"</div>";if(new Date(a[1])>new Date)return this.blockingMessage=c(e).css({color:"red"}).prependTo(c("#submit_record__row")),!1}return!0},_showFlagInfo:function(){var a=this.flagInfo,e=c(this.idPrefix+"_flaginfo__row .controls").empty(),
a=a.length?JSON.parse(a.val()):[],d=a.length;if(d){e.addClass("has-flaginfo");for(var e=c('<div class="checkpoint-advise">').hide().appendTo(e),b,f,g=0;g<d;g++)b=a[g],f=c('<div class="checkpoint-instructions">').appendTo(e),c("<h4>"+b.n+"</h4>").appendTo(f),b.i&&c("<p>"+b.i+"</p>").appendTo(f);e.slideDown()}},_hideDetails:function(){var a=this.idPrefix;c(a+"_person__row .controls").text()?c(a+"_details__row").show():c(a+"_details__row").hide();c(a+"_date__row").hide();c(a+"_comments__row").hide()},
_showDetails:function(a){var e=this.idPrefix;c(e+"_details__row").show();a&&(c(e+"_date__row").show(),c(e+"_comments__row").show())},_updateDetails:function(a,e){var d=this.idPrefix;c(d+"_details__row .controls");c(d+"_date__row .controls");var b=this.actionDetails;b.length&&(""!==a.h?b.val(JSON.stringify(a.h)):b.val("[]"));c(d+"_details__row .controls").html(a.d);c(d+"_date__row .controls").html(a.t);this._showDetails(e)},_clearDetails:function(){var a=this.idPrefix;this._hideDetails();c(a+"_details__row .controls").empty();
c(a+"_date__row .controls").empty();c(a+"_comments").val("")},_toggleSubmit:function(a){var e=c(this.element),d=[".check-btn",".submit-btn"],b=this.permissionInfo,f=this.actionableInfo;if(a){var g=a=!1;b.length&&(b=b.val())&&(a=JSON.parse(b));a&&(g=!0,f.length&&(f=f.val())&&(g=JSON.parse(f)));a&&g&&(g=this._checkBlockedEvents());a&&g&&d.reverse()}b=e.find(d[0]);e.find(d[1]).prop("disabled",!0).hide().insertAfter(b);b.prop("disabled",!1).hide().removeClass("hide").show()},_clearAlert:function(){c(".alert-error, .alert-warning, .alert-info, .alert-success").fadeOut("fast");
c(".error_wrapper").fadeOut("fast").remove()},_clearForm:function(a,e){var d=c(this.element),b=this.idPrefix;c(".inline-throbber").remove();a||this._clearAlert();this.blockedEvents={};this.blockingMessage&&this.blockingMessage.remove();d.find('input[type="hidden"][name="intervals"]').val(JSON.stringify(this.blockedEvents));this.flagInfo.val("[]");this.permissionInfo.val("false");e||c(b+"_label").val("");c(b+"_person__row .controls").hide().empty();c(b+"_flaginfo__row .controls").empty();this._clearDetails();
this._toggleSubmit(!1)},_bindEvents:function(){var a=c(this.element),e=this.idPrefix,d=this.namespace,b=this,f=c(".zxing-button"),g=c("#event-type-toggle"),h=c("#event-type-selector");-1==navigator.userAgent.toLowerCase().indexOf("android")?f.addClass("disabled").click(function(a){a.preventDefault();a.stopPropagation();return!1}):f.bind("click"+d,function(){b._clearAlert()});g.bind("click"+d,function(){b._clearAlert();h.hasClass("hide")?h.hide().removeClass("hide").slideDown():h.slideToggle()});h.find("a.event-type-selector").bind("click"+
d,function(){var a=c(this),d=a.data("code"),a=a.data("name");c('input[type="hidden"][name="event"]').val(d);c(".event-type-name").text(a);c(e+"_person__row .controls").text()&&b._toggleSubmit(!0);f.each(function(){var a=c(this),b=a.data("tmp");b&&a.attr("href",b.replace("%7BEVENT%7D",d))});h.slideUp()});a.find("a.cancel-action").bind("click"+d,function(a){a.preventDefault();b._clearForm()});this.options.ajax&&(a.find(".check-btn").bind("click"+d,function(a){a.preventDefault();b._checkID()}),a.find(".submit-btn").unbind(d).bind("click"+
d,function(a){a.preventDefault();b._registerEvent()}));a=c(e+"_label");a.bind("input"+d,function(a){b._clearForm(!1,!0)});a.bind("keyup"+d,function(a){switch(a.which){case 27:b._clearForm()}});return!0},_unbindEvents:function(){var a=c(this.element),e=this.namespace,d=this.idPrefix;c(".zxing-button").unbind(e).unbind("click");c("#event-type-toggle").unbind(e);c("#event-type-selector").find("a.event-type-selector").unbind(e);c(d+"_label").unbind(e);a.find("a.cancel-action").unbind(e);a.find(".check-btn").unbind(e);
a.find(".submit-btn").unbind(e);return!0}})})(jQuery);
