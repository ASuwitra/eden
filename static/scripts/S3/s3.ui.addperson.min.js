/*
 2017 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.owns=function(b,h){return Object.prototype.hasOwnProperty.call(b,h)};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(b,h,n){b!=Array.prototype&&b!=Object.prototype&&(b[h]=n.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,h,n,l){if(h){n=$jscomp.global;b=b.split(".");for(l=0;l<b.length-1;l++){var a=b[l];a in n||(n[a]={});n=n[a]}b=b[b.length-1];l=n[b];h=h(l);h!=l&&null!=h&&$jscomp.defineProperty(n,b,{configurable:!0,writable:!0,value:h})}};$jscomp.polyfill("Object.values",function(b){return b?b:function(b){var h=[],l;for(l in b)$jscomp.owns(b,l)&&h.push(b[l]);return h}},"es8","es3");
(function(b,h){var n=function(a,b){var c=function(a,b){return b?encodeURIComponent(a)+"="+encodeURIComponent(b):""},d=a.split("?"),d=[d[0]].concat(d[1].split("#")),f=d[1],g,k={},m,f=f?f.split("&").map(function(a){g=decodeURIComponent(a.split("=")[0]);return b.hasOwnProperty(g)?(k[g]=!0,c(g,b[g])):a}).filter(function(a){return a}):[];for(g in b)k[g]||(m=c(g,b[g]))&&f.push(m);m=d[0];f.length&&(m+="?"+f.join("&"));d[2]&&(m+="#"+d[2]);return m};S3.addPersonWidgetReady=function(a){var c=new jQuery.Deferred,
e=b("#"+a);if(e.data("lookup_contact")!==h)c.resolve(e);else e.on("addPersonReady",function(){c.resolve(e)});return c.promise()};var l=0;b.widget("s3.addPerson",{options:{lookupDuplicates:!1,separateNameFields:!1,trigger:"full_name",c:"pr",f:"person",chars:2,delay:800,downIcon:"fa fa-caret-down",yesIcon:"fa fa-check",noIcon:"fa fa-remove"},_create:function(){this.id=l;l+=1;this.eventNamespace=".addPerson"},_init:function(){var a=b(this.element),c=this.options;this.fieldName=a=a.attr("id");this.selector=
"#"+a;this.data={};a=b(this.selector+"__row").hide();a.hasClass("form-row")||a.hasClass("control-group")?this.formStyle="div":this.formStyle="table";this.topFields=["organisation_id","pe_label"];a=b(this.selector+"_pe_label");a.length&&(this.idLabel=a);var a=c.trigger;if(c.separateNameFields)if("first_name"==a)var e=["first_name","middle_name","last_name"];else a="last_name",e=["last_name","middle_name","first_name"];else a="full_name",e=["full_name"];c.trigger=a;this.triggerRow=b(this._rowSelector(a));
this.trigger=b(this.selector+"_"+a);this.nameFields=e;this.personFields="father_name grandfather_name year_of_birth date_of_birth gender occupation mobile_phone home_phone email".split(" ");this._arrangeFormRows();this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){var a=b(this.element),c=this.selector,e=this.options;this._unbindEvents();var d=this.throbber;d&&d.remove();d=b('<div class="throbber input_throbber"></div>');d.hide().insertAfter(this.trigger);
this.throbber=d;var f=this.idLabel;f&&(d=b('<div class="throbber input_throbber"></div>'),d.hide().insertAfter(f),this.idLabelThrobber=d);(d=a.val())?(isNaN(d-0)||(this.data={id:d},this._serialize()),this._disableInputs(),this._toggleActions({cancel:!1})):(this._serialize(),this._enableAutocomplete(),this._toggleActions({edit:!1}));b(c+"_edit_bar").removeClass("hide").show();e.lookupDuplicates&&(e='<div id="'+this.fieldName+'_duplicates" class="req"></div>',"div"==this.formStyle?b(c+"_box_bottom").before(e):
b(c+"_box_bottom1").before(e));this._bindEvents();a.trigger("addPersonReady")},_arrangeFormRows:function(){var a=b(this.element),c=this.selector,e=b(c+"__row").hide();if("div"==this.formStyle){var d=b(c+"_box_bottom");e.after(d.removeClass("hide").show());var f=this,d=this.topFields.concat(this.nameFields).concat(this.personFields).reverse();d.forEach(function(a){e.after(b(f._rowSelector(a)))});b(d.map(this._rowSelector,this).join(",")).removeClass("hide").show()}else b(c+"__row1").hide();c=b(c+"_title__row");
a=a.next(".error_wrapper");e.after(a).after(c.removeClass("hide").show())},_allFields:function(){return this.topFields.concat(this.nameFields).concat(this.personFields)},_fieldMap:function(){var a={pe_label:"pe_label",email:"email",mobile_phone:"mphone",home_phone:"hphone",gender:"sex",date_of_birth:"dob",year_of_birth:"year_of_birth",father_name:"father_name",grandfather_name:"grandfather_name",occupation:"occupation",organisation_id:"org_id"};this.options.separateNameFields&&(a.first_name="first_name",
a.middle_name="middle_name",a.last_name="last_name");return a},_rowSelector:function(a){return this.selector+"_"+a+"__row"},_readInputs:function(){var a=this.selector,c={},e;this._allFields().forEach(function(d){e=b(a+"_"+d);e.length&&(c[d]=e.val())});this.data=c},_updateInputs:function(){var a=this.selector,c=this.data,e;this._allFields().forEach(function(d){e=b(a+"_"+d);e.length&&c.hasOwnProperty(d)&&e.val(c[d])})},_serialize:function(){b(this.element).val(JSON.stringify(this.data))},_deserialize:function(){var a=
b(this.element).val(),c=a-0;this.data=isNaN(c)?JSON.parse(a):{id:c}},_toggleActions:function(a){var c={edit:".edit-action",cancel:".cancel-action"},e=this.selector,d;for(d in a){var f=b(e+"_edit_bar "+c[d]);a[d]?f.removeClass("hide").show():f.hide()}},_toggleDatePickerTrigger:function(a){var c=b(this.selector+"_date_of_birth__row .calendar-clear-btn"),e=b(this.selector+"_date_of_birth__row .ui-datepicker-trigger");a?(e.removeClass("hide").show(),c.removeClass("hide").show()):(e.hide(),c.hide())},
_enableInputs:function(){var a=this.selector;this._allFields().forEach(function(c){b(a+"_"+c).prop("disabled",!1)});this._toggleDatePickerTrigger(!0)},_disableInputs:function(){var a=this.selector;this._allFields().forEach(function(c){b(a+"_"+c).prop("disabled",!0)});this._toggleDatePickerTrigger(!1);this._toggleActions({edit:!0,cancel:!1})},_reset:function(a){var c=this.topFields.concat(this.personFields);a||(c=c.concat(this.nameFields));var e=this.selector;c.forEach(function(a){b(e+"_"+a).prop("disabled",
!1).val("")});this._toggleDatePickerTrigger(!0);a?this._readInputs():this.data={};this._serialize()},_stashSelection:function(){this.previousSelection=b.extend({},this.data)},_edit:function(){this._stashSelection();this._reset();this._enableAutocomplete();this._toggleActions({edit:!1,cancel:!0})},_cancel:function(){var a=this.previousSelection;a&&Object.values(a).length?(this.data=b.extend({},this.previousSelection),this._serialize(),this._updateInputs(),this._disableInputs()):this._reset();this._clearDuplicates()},
_clearError:function(){b(this.selector+"_title__row").next(".error_wrapper").fadeOut("slow",function(){S3.hideAlerts()})},_fullName:function(a){return a.label!==h?a.label:a.name},_autocompleteLabel:function(a){if(a.label!==h)return a.label;var b=a.name;a=[a.job,a.org].filter(function(a){return a});a.length&&(b+=" ("+a.join(",")+")");return b},_enableAutocomplete:function(){var a=this.trigger;if(!a.attr("autocomplete")){var c=this.options,e=this;this.acURL=S3.Ap.concat("/"+c.c+"/"+c.f+"/search_ac");
var d=a.autocomplete({delay:c.delay,minLength:c.chars,source:function(a,c){b.ajax({url:e.acURL,data:{term:a.term}}).done(function(a){0===a.length?delete e.data.id:a.push({id:0,value:"",label:i18n.none_of_the_above});c(a)})},search:function(){e.throbber.show();return!0},response:function(a,b,c){e.throbber.hide();return c},focus:function(){return!1},select:function(b,d){var f=d.item;f.id?(c.separateNameFields||a.val(e._fullName(f)),e._selectPerson(f.id)):delete e.data.id;return!1}}).data("ui-autocomplete");
d&&(d._renderItem=function(a,c){var d=e._autocompleteLabel(c);return b("<li>").data("item.autocomplete",c).append("<a>"+d+"</a>").appendTo(a)})}},_selectPerson:function(a){var c=this.options,e=this.selector,d=c.trigger,f;this.nameFields.forEach(function(a){f=b(e+"_"+a).prop("disabled",!1);a!=d&&f.val("")});this._reset(!0);var g=this,k=this.trigger,m=S3.Ap.concat("/"+c.c+"/"+c.f+"/"+a+"/lookup.json");this.idLabel&&(m+="?label=1");this.throbber.show();k.val()||k.attr("placeholder",i18n.loading+"...");
b.getJSONS3(m,function(b){try{g.data.id=a,c.separateNameFields||(g.data.full_name=k.val()),g._processReponse(b)}catch(p){g._reset(!0)}g.throbber.hide();k.removeAttr("placeholder")})},_processReponse:function(a){var b=this._fieldMap(),e=this.data,d;for(d in b){var f=b[d]||d;a.hasOwnProperty(f)&&(e[d]=a[f])}this._serialize();this._stashSelection();this._updateInputs();this._disableInputs()},lookupIDLabel:function(){var a=this.idLabel;if(a){var c=a.val();if(c){var e=a.data("lookup");e&&(e.abort(),a.data("lookup",
null));var d=this.options,f=this,g=this.idLabelThrobber.show(),c=S3.Ap.concat("/"+d.c+"/"+d.f+"/lookup.json?search=1&label=1&~.pe_label="+c),e=b.getJSONS3(c,function(b){b.pe_label&&(f.data.id=b.id,d.separateNameFields||(f.data.full_name=b.name),f._processReponse(b));a.data("lookup",null);g.hide()});a.data("lookup",e)}}},lookupContact:function(a){this._reset();var c=this.options,e=this.trigger,d=this;a=S3.Ap.concat("/org/site/"+a+"/site_contact_person");this.throbber.show();e.val()||e.attr("placeholder",
i18n.loading+"...");b.getJSONS3(a,function(a){try{d.data.id=a.id;if(!c.separateNameFields){var b=a.name;e.val(b);d.data.full_name=b}d._processReponse(a)}catch(k){d._reset()}d.throbber.hide();e.removeAttr("placeholder")})},_checkDuplicates:function(){var a=this.options,c=this._fieldMap(),e=this.selector,d=this.data,f={};if(!d.id){if(a.separateNameFields){if(!d.first_name)return;this.nameFields.forEach(function(a){(g=d[a])&&(f[c[a]||a]=g)})}else{var g=d.full_name;if(!g)return;f.name=g}this.personFields.forEach(function(a){(g=
d[a])&&(f[c[a]||a]=g)});var k=S3.Ap.concat("/pr/person/check_duplicates");b.ajaxS3({url:k,data:f,type:"POST",dataType:"json",success:function(c){b(e+"_results").remove();if(c.length){var d=i18n.dupes_found.replace("_NUM_",c.length)+' <i class="'+a.downIcon+'"> </i>';b(e+"_duplicates").html(d).data("results",c).show()}else b(e+"_duplicates").data("results",[]).hide()}})}},_displayDuplicates:function(){var a=this.options,c=this.selector;if(!b(c+"_results").length){var e=function(a,c){var d=b("<div>").addClass("card_1_line");
c&&d.append(b("<label>").html(c));return d.append(a)},d=function(a,c){var d=b('<button type="button" class="fright">');c&&d.append(b('<i class="'+c+'">'));return d.append(a)},c=b(c+"_duplicates"),f=c.data("results"),g=b('<div id="'+this.fieldName+'_results">'),k,m,h,l;f.forEach(function(c){m=c.name;k=b('<div class="dl-item">').data({id:c.id,name:m});h=b('<img width="50" height="50" class="media-object">');l=c.image?"/default/download/"+c.image:"/static/img/blank-user.gif";h.attr("src",S3.Ap.concat(l));
k.append(b('<a class="fleft">').append(h));c.org&&k.append(e(c.org));k.append(e(m));c.father_name&&i18n.father_name_label&&k.append(e(c.father_name,i18n.father_name_label));c.grandfather_name&&i18n.grandfather_name_label&&k.append(e(c.grandfather_name,i18n.grandfather_name_label));["year_of_birth","dob","email","phone"].forEach(function(a){(a=c[a])&&k.append(e(a))});k.append(d(i18n.Yes,a.yesIcon));g.append(k)});f=b('<div class="dl-item">').append(d(i18n.No,a.noIcon));g.append(f);c.after(g);b("html,body").animate({scrollTop:c.offset().top},
250)}},_selectDuplicate:function(a,c){var e=this.selector,d=b(e+"_duplicates");a&&c?(b(e+"_full_name").val(c),this._clearDuplicates(),d.data("submit")?(this.data={id:a},this._serialize(),d.closest("form").off(this.eventNamespace).submit()):(this.options.separateNameFields&&this.trigger.val(""),this._selectPerson(a))):(this._clearDuplicates(),d.data("submit")&&d.closest("form").off(this.eventNamespace).submit())},_clearDuplicates:function(){var a=this.selector;b(a+"_duplicates").data("results",[]).empty();
b(a+"_results").remove()},_onFormSubmit:function(a){var c=this.selector;if(this.options.lookupDuplicates&&(c=b(c+"_duplicates"),c.data("results").length))return c.data("submit",!0),this._displayDuplicates(),!1;this.data.id?this.data={id:this.data.id}:this._readInputs();this._serialize();b(a).off(this.eventNamespace).submit();return!0},_bindEvents:function(){var a=b(this.element),c=this.options,e=this.selector,d=this.eventNamespace,f=this;a.closest("form").on("submit"+d,function(a){a.preventDefault();
return f._onFormSubmit(this)});b(e+"_edit_bar .edit-action").on("click"+d,function(){f._clearError();f._edit()});b(e+"_edit_bar .cancel-action").on("click"+d,function(){f._clearError();f._cancel()});b(e+"_organisation_id").change(function(){f.acURL=n(f.acURL,{"~.organisation_id":b(this).val()})});b(e+"_title__row").next(".error_wrapper").one("click"+d,function(){f._clearError();return!1});var g=this.nameFields.concat(this.personFields);b(g.map(function(a){return e+"_"+a}).join(",")).on("change"+d,
function(){f._readInputs();f._serialize();c.lookupDuplicates&&f._checkDuplicates()});c.lookupDuplicates&&(b(e+"_duplicates").data("results",[]).on("click"+d,function(){f._displayDuplicates()}),a.closest("form").on("click"+d,e+"_results .dl-item",function(){var a=b(this),c=a.data("id"),a=a.data("name");f._selectDuplicate(c,a)}),a.on("change"+d,function(){a.val()&&f._clearDuplicates()}));if(g=this.idLabel)g.on("input"+d,function(){var a=b(this),d=a.data("lookupTimeout");d&&clearTimeout(d);d=setTimeout(function(){f.lookupIDLabel()},
c.delay);a.data("lookupTimeout",d)}),g.on("blur"+this.eventNamespace,function(){var a=b(this),c=a.data("lookup"),d=a.data("lookupTimeout");c&&(c.abort(),a.data("lookup",null),f.idLabelThrobber.hide());d&&clearTimeout(d)});return!0},_unbindEvents:function(){var a=b(this.element),c=this.selector,e=this.eventNamespace;a.off(e);a.closest("form").off(e);b(c+"_edit_bar .edit-action").off(e);b(c+"_edit_bar .cancel-action").off(e);b(c+"_duplicates").off(e);a=this.nameFields.concat(this.personFields);b(a.map(function(a){return c+
"_"+a}).join(",")).off(e);(a=this.idLabel)&&a.off(e);return!0}})})(jQuery);
