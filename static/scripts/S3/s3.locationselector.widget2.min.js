(function(){S3.gis.locationselector=function(b,a,d,e,c,f,g,p,m,q){var k="#"+b,w=$(k),D=w.next(".error_wrapper"),A=$(k+"_L0__row"),s=$(k+"_L1__row"),u=$(k+"_L2__row"),y=$(k+"_L3__row"),t=$(k+"_L4__row"),z=$(k+"_L5__row"),E=$(k+"_address__row"),F=$(k+"_postcode__row"),B=$(k+"_map_icon__row"),G=$(k+"__row .map_wrapper").attr("id",b+"_map_wrapper");d?$(k+"__row").hide().after(G).after(B).after(A).after(s).after(u).after(y).after(t).after(z).after(F).after(E).after(D):$(k+"__row").hide().after(G).after(B).after(F).after(E).after(z).after(t).after(y).after(u).after(s).after(A).after(D);
q&&w.data("specific",q);w.data("hide_lx",a);if(e)r(b,0,e);else{A.removeClass("hide").show();a=[];for(var x in l)v=l[x],0==v.l&&(v.i=x,a.push(v));a.sort(H);d=$(k+"_L0");x=0;for(e=a.length;x<e;x++)w=a[x],q=w.i,q='<option value="'+q+'">'+w.n+"</option>",d.append(q)}c&&r(b,1,c);f&&r(b,2,f);g&&r(b,3,g);p&&r(b,4,p);m&&r(b,5,m);I(b);B.removeClass("hide").show();c=$(k+"_lat").val();f=$(k+"_lon").val();g=$(k+"_wkt").val();c||f||g?C(b):$(k+"_map_icon").click(function(){C(b);return!1});$(k+"_L0").change(function(){r(b,
0)});$(k+"_L1").change(function(){r(b,1)});$(k+"_L2").change(function(){r(b,2)});$(k+"_L3").change(function(){r(b,3)});$(k+"_L4").change(function(){r(b,4)});$(k+"_L5").change(function(){r(b,5)})};var r=function(b,a,d){var e="#"+b,c=$(e).data("hide_lx");d?$(e+"_L"+a).val(d):d=parseInt($(e+"_L"+a).val());if(0===a){var f=h[d];if(void 0==f){var g=S3.Ap.concat("/gis/hdata/"+d);$.ajaxS3({async:!1,url:g,dataType:"script",success:function(a){f={};for(var b in n)f[b]=n[b];h[d]=f;n=null},error:function(a,b,
e){msg="UNAUTHORIZED"==e?i18n.gis_requires_login:a.responseText;s3_debug(msg)}})}for(var p=h.d,m,q,k=["1","2","3","4","5"],g=0;5>g;g++)m=k[g],q=f[m]||p[m],m=$(e+"_L"+m+"__row label"),m.hasClass("required")?m.html("<div>"+q+':<span class="req"> *</span></div>'):m.html(q+":")}if(d){for(m=a+1;6>m;m++)p=e+"_L"+m,c?$(p+"__row").hide():$(p+" option").remove('[value != ""]'),$(p).val("");s(b);a+=1;c=$(e+"_L"+a+"__row");if(c.length){c.removeClass("hide").show();c=!0;for(g in l)l[g].f==d&&(c=!1);c&&J(b,a,
d);c=[];for(g in l)v=l[g],v.l==a&&v.f==d&&(v.i=g,c.push(v));c.sort(H);p=$(e+"_L"+a);$(e+"_L"+a+" option").remove('[value != ""]');g=0;for(a=c.length;g<a;g++)m=c[g],e=m.i,q=d==e?' selected="selected"':"",e='<option value="'+e+'"'+q+">"+m.n+"</option>",p.append(e)}else $(e+"_geocode button").length&&t(b)}else for(0===a?d="d":(d=$(e+"_L"+(a-1)).val())||(d="d"),s(b),m=a+1;6>m;m++)p=e+"_L"+m,c?$(p+"__row").hide():$(p+" option").remove('[value != ""]'),$(p).val("");y(b,d)},H=function(b,a){b=b.n;var d=[b,
a.n];d.sort();return d[0]==b?-1:1},J=function(b,a,d){b="#"+b;var e=$(b+"_L"+a);e.hide();var c=$(b+"_L"+a+"__throbber");c.removeClass("hide").show();a=S3.Ap.concat("/gis/ldata/"+d);$.ajaxS3({async:!1,url:a,dataType:"script",success:function(a){for(var b in n)l[b]=n[b];n=null;c.hide();e.removeClass("hide").show()},error:function(a,b,d){msg="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;s3_debug(msg);alert(msg);c.hide();e.removeClass("hide").show()}})},u=function(b){b="#"+b+"_L";for(var a,
d=5;-1<d;d--)if(a=$(b+d).val())return a;return l.d.id},s=function(b){var a="#"+b,d=$(a+"_parent"),e=$(a);if(e.data("specific"))e=u(b),d.val(e);else{var c=$(a+"_address").val(),f=$(a+"_postcode").val(),g=$(a+"_lat").val(),p=$(a+"_lon").val(),a=$(a+"_wkt").val();c||f||g||p||a?(e.val("dummy"),e=u(b),d.val(e)):(b=u(b),e.val(b),d.val(""))}},I=function(b){var a="#"+b;$(a+"_address__row").removeClass("hide").show();$(a+"_postcode__row").removeClass("hide").show();$(a+"_geocode button").length&&$(a+"_address,"+
a+"_postcode").change(function(){t(b)})},t=function(b){var a="#"+b;if($(a+"_address").val()){var d,e,c=["1","2","3","4","5"];for(d=0;5>d;d++)if(e=c[d],e=$(a+"_L"+e),e.length&&!e.val())return;$(a).data("manually_geocoded")?($(a+"_geocode .geocode_success").hide(),$(a+"_geocode .geocode_fail").hide(),$(a+"_geocode button").removeClass("hide").show().click(function(){$(this).hide();z(b);s(b)})):z(b);s(b)}},z=function(b){var a="#"+b,d=$(a+"_geocode .geocode_fail"),e=$(a+"_geocode .geocode_success");d.hide();
e.hide();var c=$(a+"_geocode .throbber");c.removeClass("hide").show();var f={address:$(a+"_address").val()},g=$(a+"_postcode").val();g&&(f.postcode=g);if(g=$(a+"_L0").val())f.L0=g;if(g=$(a+"_L1").val())f.L1=g;if(g=$(a+"_L2").val())f.L2=g;if(g=$(a+"_L3").val())f.L3=g;if(g=$(a+"_L4").val())f.L4=g;if(g=$(a+"_L5").val())f.L5=g;g=S3.Ap.concat("/gis/geocode");$.ajaxS3({url:g,type:"POST",data:f,dataType:"json",success:function(f){var g=f.lat,q=f.lon;if(g||q){$(a+"_lat").val(g);$(a+"_lon").val(q);gis=S3.gis;
if(gis.maps){var k=gis.maps["location_selector_"+b];k&&(f=k.s3.draftLayer,f.removeAllFeatures(),g=new OpenLayers.Geometry.Point(parseFloat(q),parseFloat(g)),g.transform(gis.proj4326,k.getProjectionObject()),g=new OpenLayers.Feature.Vector(g),f.addFeatures([g]),y(b))}c.hide();e.html(i18n.address_mapped).removeClass("hide").show()}else c.hide(),d.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(f)},error:function(a,b,e){msg="UNAUTHORIZED"==e?i18n.gis_requires_login:a.responseText;c.hide();
d.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(msg)}})},K=function(b){var a="#"+b,d=$(a+"_geocode .geocode_fail"),e=$(a+"_geocode .geocode_success");d.hide();e.hide();var c=$(a+"_geocode .throbber");c.removeClass("hide").show();post_data={lat:$(a+"_lat").val(),lon:$(a+"_lon").val()};b=S3.Ap.concat("/gis/geocode_r");$.ajaxS3({async:!1,url:b,type:"POST",data:post_data,dataType:"json",success:function(b){b.L0?($(a+"_L0_input").val(b.L0),$(a+"_L0").val(b.L0),b.L1&&($(a+"_L1_input").val(b.L1),
$(a+"_L1").val(b.L1)),b.L2&&($(a+"_L2_input").val(b.L2),$(a+"_L2").val(b.L2)),b.L3&&($(a+"_L3_input").val(b.L3),$(a+"_L3").val(b.L3)),b.L4&&($(a+"_L4_input").val(b.L4),$(a+"_L4").val(b.L4)),b.L5&&($(a+"_L5_input").val(b.L5),$(a+"_L5").val(b.L5)),c.hide(),e.html(i18n.location_found).removeClass("hide").show()):(c.hide(),d.html(i18n.location_not_found).removeClass("hide").show())},error:function(b,a,e){msg="UNAUTHORIZED"==e?i18n.gis_requires_login:b.responseText;c.hide();d.html(i18n.location_not_found).removeClass("hide").show();
s3_debug(msg)}})},L=function(b){var a="#"+b;$(a+"_map_icon").unbind("click").click(function(){C(b)});$(a+"_map_wrapper").hide();S3.gis.maps["location_selector_"+b].s3.draftLayer.removeAllFeatures();$(a+"_lat").val("");$(a+"_lon").val("");s(b)},M=function(){var b=new jQuery.Deferred;setTimeout(function d(){void 0!=S3.gis.maps?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(d,500))},1);return b.promise()},C=function(b,a){var d="#"+b;$(d+"_map_icon").unbind("click").click(function(){L(b)});
$(d+"_map_wrapper").removeClass("hide").show();$.when(M()).then(function(a){a="location_selector_"+b;var c=S3.gis;if(!c.maps[a]){var f=c.show_map(a),g=$(d);$(d+"_parent");(a=u(b))||(a="d");y(b,a);var p=$(d+"_lat"),m=$(d+"_lon"),q=$(d+"_wkt"),k=p.val(),r=m.val();a=q.val();if(k||r||a)void 0!=a?(k={internalProjection:f.getProjectionObject(),externalProjection:c.proj4326},a=(new OpenLayers.Format.WKT(k)).read(a)):(a=new OpenLayers.Geometry.Point(parseFloat(r),parseFloat(k)),a.transform(c.proj4326,f.getProjectionObject()),
a=new OpenLayers.Feature.Vector(a)),f.s3.draftLayer.addFeatures([a]),s(b);var t;a=f.controls;k=0;for(r=a.length;k<r;k++)if("OpenLayers.Control.DrawFeature"==a[k].CLASS_NAME){t=a[k];break}t&&(f.s3.pointPlaced=function(a){$(d+"_geocode .geocode_fail").hide();$(d+"_geocode .geocode_success").hide();a=a.geometry;"OpenLayers.Geometry.Point"==a.CLASS_NAME?(a=a.getBounds().getCenterLonLat(),a.transform(f.getProjectionObject(),c.proj4326),p.val(a.lat),m.val(a.lon),g.data("manually_geocoded",!0),K(b)):(a=
a.transform(f.getProjectionObject(),c.proj4326).toString(),q.val(a));s(b)})}},function(a){s3_debug(a)},function(a){s3_debug(a)})},y=function(b,a){var d=S3.gis;if(d.maps){var e=d.maps["location_selector_"+b];if(e){var c="#"+b,f=$(c+"_lat"),c=$(c+"_lon"),f=f.val(),c=c.val();if(f&&c)f=[c-0.032,f-0.032,c+0.032,f+0.032];else if(f=l[a].b,!f&&(c=l[a].f,c=l[c]))if(f=c.b,!f&&(c=c.f,c=l[c]))if(f=c.b,!f&&(c=c.f,c=l[c]))f=c.b;f&&(f=OpenLayers.Bounds.fromArray(f).transform(d.proj4326,e.getProjectionObject()),
e.zoomToExtent(f))}}}})();
