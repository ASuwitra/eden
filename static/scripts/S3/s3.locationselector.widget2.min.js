(function(){S3.gis.locationselector=function(b,a,e,c,d,g,f,k,t,m){var h="#"+b,r=$(h),y=r.next(".error_wrapper"),q=$(h+"_L0__row"),s=$(h+"_L1__row"),u=$(h+"_L2__row"),z=$(h+"_L3__row"),A=$(h+"_L4__row"),B=$(h+"_L5__row"),C=$(h+"_address__row"),D=$(h+"_postcode__row"),w=$(h+"_map_icon__row"),E=$(h+"__row .map_wrapper").attr("id",b+"_map_wrapper");e?$(h+"__row").hide().after(E).after(w).after(q).after(s).after(u).after(z).after(A).after(B).after(D).after(C).after(y):$(h+"__row").hide().after(E).after(w).after(D).after(C).after(B).after(A).after(z).after(u).after(s).after(q).after(y);
m&&r.data("specific",m);r.data("hide_lx",a);c&&p(b,0,c);d&&p(b,1,d);g&&p(b,2,g);f&&p(b,3,f);k&&p(b,4,k);t&&p(b,5,t);F(b);w.show();a=$(h+"_lat").val();e=$(h+"_lon").val();c=$(h+"_wkt").val();a||e||c?x(b):$(h+"_map_icon").click(function(){x(b)});$(h+"_L0").change(function(){p(b,0)});$(h+"_L1").change(function(){p(b,1)});$(h+"_L2").change(function(){p(b,2)});$(h+"_L3").change(function(){p(b,3)});$(h+"_L4").change(function(){p(b,4)});$(h+"_L5").change(function(){p(b,5)})};var p=function(b,a,e){var c=
"#"+b,d=$(c).data("hide_lx");e?$(c+"_L"+a).val(e):e=$(c+"_L"+a).val();if(e){for(var g=a+1;6>g;g++){var f=c+"_L"+g;d?$(f+"__row").hide():$(f+" option").remove('[value != ""]');$(f).val("")}q(b);a+=1;d=$(c+"_L"+a+"__row");if(d.length){d.show();var d=!0,k;for(k in l)l[k].f==e&&(d=!1);d&&G(b,a,e);d=[];for(k in l)v=l[k],v.l==a&&v.f==e&&(v.i=k,d.push(v));d.sort(H);var t,g=$(c+"_L"+a);$(c+"_L"+a+" option").remove('[value != ""]');k=0;for(a=d.length;k<a;k++)f=d[k],c=f.i,t=e==c?' selected="selected"':"",c=
'<option value="'+c+'"'+t+">"+f.n+"</option>",g.append(c)}}else for(0===a?e="d":(e=$(c+"_L"+(a-1)).val())||(e="d"),q(b),g=a+1;6>g;g++)f=c+"_L"+g,d?$(f+"__row").hide():$(f+" option").remove('[value != ""]'),$(f).val("");u(b,e)},H=function(b,a){b=b.n;var e=[b,a.n];e.sort();return e[0]==b?-1:1},G=function(b,a,e){b="#"+b;var c=$(b+"_L"+a);c.hide();var d=$(b+"_L"+a+"__throbber");d.show();a=S3.Ap.concat("/gis/ldata/"+e);$.ajax({async:!1,url:a,dataType:"script"}).done(function(a){for(var b in n)l[b]=n[b];
n=null;d.hide();c.show()}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText})},s=function(b){b="#"+b+"_L";for(var a,e=5;-1<e;e--)if(a=$(b+e).val())return a;return l.d.id},q=function(b){var a="#"+b,e=$(a+"_parent"),c=$(a);if(c.data("specific"))c=s(b),e.val(c);else{var d=$(a+"_address").val(),g=$(a+"_postcode").val(),f=$(a+"_lat").val(),k=$(a+"_lon").val(),a=$(a+"_wkt").val();d||g||f||k||a?(c.val("dummy"),c=s(b),e.val(c)):(b=s(b),c.val(b),e.val(""))}},F=function(b){var a=
"#"+b;$(a+"_address__row").show();$(a+"_postcode__row").show();$(a+"_address").change(function(){I(b);q(b)})},I=function(b){var a="#"+b,e=$(a+"_geocode .geocode_fail"),c=$(a+"_geocode .geocode_success");e.hide();c.hide();var d=$(a+"_geocode .throbber");d.removeClass("hide").show();var g={address:$(a+"_address").val()},f=$(a+"_postcode").val();f&&(g.postcode=f);if(f=$(a+"_L0").val())g.L0=f;if(f=$(a+"_L1").val())g.L1=f;if(f=$(a+"_L2").val())g.L2=f;if(f=$(a+"_L3").val())g.L3=f;if(f=$(a+"_L4").val())g.L4=
f;if(f=$(a+"_L5").val())g.L5=f;f=S3.Ap.concat("/gis/geocode");$.ajax({async:!1,url:f,type:"POST",data:g,dataType:"json"}).done(function(g){var f=g.lat,m=g.lon;if(f||m){$(a+"_lat").val(f);$(a+"_lon").val(m);gis=S3.gis;if(gis.maps){var h=gis.maps["location_selector_"+b];h&&(g=h.s3.draftLayer,g.removeAllFeatures(),f=new OpenLayers.Geometry.Point(parseFloat(m),parseFloat(f)),f.transform(gis.proj4326,h.getProjectionObject()),f=new OpenLayers.Feature.Vector(f),g.addFeatures([f]))}d.hide();c.removeClass("hide").show()}else d.hide(),
e.removeClass("hide").show(),s3_debug(g)}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;d.hide();e.removeClass("hide").show();s3_debug(msg)})},J=function(b){var a="#"+b,e=$(a+"_geocode .geocode_fail"),c=$(a+"_geocode .geocode_success");e.hide();c.hide();var d=$(a+"_geocode .throbber");d.removeClass("hide").show();post_data={lat:$(a+"_lat").val(),lon:$(a+"_lon").val()};b=S3.Ap.concat("/gis/geocode_r");$.ajax({async:!1,url:b,type:"POST",data:post_data,dataType:"json"}).done(function(b){b.L0?
($(a+"_L0_input").val(b.L0),$(a+"_L0").val(b.L0),b.L1&&($(a+"_L1_input").val(b.L1),$(a+"_L1").val(b.L1)),b.L2&&$(a+"_L2").val(b.L2),b.L3&&$(a+"_L3").val(b.L3),b.L4&&$(a+"_L4").val(b.L4),b.L5&&$(a+"_L5").val(b.L5),d.hide(),c.removeClass("hide").show()):(d.hide(),e.removeClass("hide").show(),s3_debug(b))}).fail(function(b,a,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:b.responseText;d.hide();e.removeClass("hide").show();s3_debug(msg)})},K=function(b){var a="#"+b;$(a+"_map_icon").unbind("click").click(function(){x(b)});
$(a+"_map_wrapper").hide();S3.gis.maps["location_selector_"+b].s3.draftLayer.removeAllFeatures();$(a+"_lat").val("");$(a+"_lon").val("");q(b)},x=function(b,a){var e="#"+b;$(e+"_map_icon").unbind("click").click(function(){K(b)});$(e+"_map_wrapper").show();var c="location_selector_"+b,d=S3.gis;if(!d.maps||!d.maps[c]){var g=d.show_map(c);$(e);$(e+"_parent");(c=s(b))||(c="d");u(b,c);var f=$(e+"_lat"),k=$(e+"_lon"),p=$(e+"_wkt"),m=f.val(),h=k.val(),c=p.val();if(m||h||c)void 0!=c?(m={internalProjection:g.getProjectionObject(),
externalProjection:d.proj4326},c=(new OpenLayers.Format.WKT(m)).read(c)):(c=new OpenLayers.Geometry.Point(parseFloat(h),parseFloat(m)),c.transform(d.proj4326,g.getProjectionObject()),c=new OpenLayers.Feature.Vector(c)),g.s3.draftLayer.addFeatures([c]),q(b);for(var r,c=g.controls,m=0,h=c.length;m<h;m++)if("OpenLayers.Control.DrawFeature"==c[m].CLASS_NAME)return r=c[m],!1;r&&r.events.register("featureadded",null,function(a){$(e+"_geocode .geocode_fail").hide();$(e+"_geocode .geocode_success").hide();
a=a.feature.geometry;"OpenLayers.Geometry.Point"==a.CLASS_NAME?(a=a.getBounds().getCenterLonLat(),a.transform(g.getProjectionObject(),d.proj4326),f.val(a.lat),k.val(a.lon),J(b)):(a=a.transform(g.getProjectionObject(),d.proj4326).toString(),p.val(a));q(b)})}},u=function(b,a){if(S3.gis.maps){var e=S3.gis.maps["location_selector_"+b];if(e){var c=l[a].b;if(!c){var d=l[a].f;if(d=l[d])if(c=d.b,!c&&(d=d.f,d=l[d]))if(c=d.b,!c&&(d=d.f,d=l[d]))c=d.b}c&&(c=OpenLayers.Bounds.fromArray(c).transform(S3.gis.proj4326,
e.getProjectionObject()),e.zoomToExtent(c))}}}})();
